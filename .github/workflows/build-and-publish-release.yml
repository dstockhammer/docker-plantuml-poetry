name: Build and publish Docker image

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Log in to Docker registry
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} \
          | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
    - name: Build Docker image
      run: |
        chmod +x plantuml.sh
        docker build -t plantuml-poetry:latest . \
          --build-arg "plantuml_version=${GITHUB_REF##*/}"
    - name: Test all required executables
      run: |
        docker run --rm plantuml-poetry plantuml -version
        docker run --rm plantuml-poetry java --version
        docker run --rm plantuml-poetry python --version
        docker run --rm plantuml-poetry poetry --version
    - name: Tag Docker image
      run: |
        docker tag plantuml-poetry:latest dstockhammer/plantuml-poetry:latest
        docker tag plantuml-poetry:latest dstockhammer/plantuml-poetry:${GITHUB_REF##*/}
    - name: Push Docker images
      run: |
        docker push dstockhammer/plantuml-poetry:${GITHUB_REF##*/}
        docker push dstockhammer/plantuml-poetry:latest
